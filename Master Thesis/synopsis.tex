\chapter{Synopsis}

\section{Some Results on the valuation spectra}

\begin{definition}
Let $K$ be a field and $P$ its prime field. The \textit{(Kronecker) dimension}\index{dimension!Kronecker} $\dim(K)$ of $K$ is defined as:
\[\dim(K) = \begin{cases}
\operatorname{trdeg}(K/P), & \operatorname{char}(K)>0\\
\operatorname{trdeg}(K/P)+1, & \text{otherwise}
\end{cases} \]
\end{definition}

\begin{remark}
A one-dimensional finitely generated field over its prime field is just a global field. A two-dimensional finitely generated field over $\mathbb{Q}$ is a function field in one variable over $\mathbb{Q}$.
\end{remark}

\begin{definition}\label{2.1}
Let $K$ be a field of finite dimension. We denote the set of equivalence classes of Krull valuations of $K$ by $\operatorname{Spv}(K)$. We often do not distinguish between a valuation and its equivalence class. 

We denote the valuation ring of $v\in\operatorname{Spv}(K)$ by $(\mathcal{O}_v,\mathfrak{m}_v)$ and set $U_v=\mathcal{O}_v^\times$ and $k(v)=\mathcal{O}_v/\mathfrak{m}_v$. The \textit{rank}\index{valuation!rank} of $v$ is defined as the Krull dimension of its valuation ring $\mathcal{O}_v$. The \textit{rational rank}\index{valuation!rational rank} of $v:K\to\Gamma_v$ is defined as the rank of its valuation group $\Gamma_v$ as a $\mathbb{Z}$-module:
\[\operatorname{rrank}(v) = \dim_\mathbb{Q}(\Gamma_v\otimes_\mathbb{Z}\mathbb{Q}) \]
\end{definition}

\begin{lemma}\label{rank-dimension-inequality}
Let $v\in\operatorname{Spv}(K)$. Then we have:
\[\operatorname{rank}(v)\leq \operatorname{rrank}(v)\quad\text{and}\quad\operatorname{rrank}(v)+\dim k(v)\leq\dim(K) \]
\end{lemma}

\begin{lemma}
Let $K$ be a finitely generated field and $v\in\operatorname{Spv}(K)$ with:
\[\operatorname{rrank}(v)+\dim k(v)= \dim(K) \]
Then $\Gamma_v$ is a finitely generated $\mathbb{Z}$-module and $k(v)$ is a finitely generated field.
\end{lemma}

\begin{definition}
We define:
\begin{align*}
\operatorname{Spv}_\text{d}(K) &= \{v\in\operatorname{Spv}(K)\mid\operatorname{rank}(v)=\operatorname{rrank}(v) \} \\
\operatorname{Spv}_\text{rd}(K) &= \{v\in\operatorname{Spv}_\text{d}(K)\mid \operatorname{rrank}(v)+\dim k(v)=\dim(K) \}
\end{align*}
Valuations in $\operatorname{Spv}_\text{d}$ are called \textit{defectless}\index{valuation!defectless}, whereas those in $\operatorname{Spv}_\text{rd}$ are called \textit{rank-defectless}\index{valuation!rank-defectless}. For $\ast\in\{\text{d},\text{rd}\}$ we set:
\[\operatorname{Spv}_\ast^{(i)}(K)=\{v\in\operatorname{Spv}_\ast(K)\mid \operatorname{rrank}(v)=i \} \]
\end{definition}

\begin{definition}
We can endow $\operatorname{Spv}(K)$ with a natural topology by declaring following sets as a basis of open sets:
\[\{v\in\operatorname{Spv}(K)\mid v(x)\geq 0\text{ for all }x\in S\} \]
where $S$ ranges over all finite subsets of $K$. 
\end{definition}

\begin{lemma}
$\operatorname{Spv}(K)$ with the topology defined above is a quasicompact $T_0$-space. Every closed subset $A\subset\operatorname{Spv}(K)$ is the closure of its closed points. In particular the set of closed points $|\operatorname{Spv}(K)|$ of $\operatorname{Spv}(K)$ is a quasicompact $T_1$-space, endowed with the induced topology.
\end{lemma}

\begin{lemma}
Let $v,w\in\operatorname{Spv}(K)$. We have:
\[\mathcal{O}_w\subset\mathcal{O}_v \iff w\in\overline{\{v\}} \]
Thus $v$ is a closed point if and only if $\dim k(v)=0$.
\end{lemma}

\begin{lemma}\label{2.2-pre}
Let $v\in\operatorname{Spv}(K)$. There is a canonical bijection:
\[\{ w\in\operatorname{Spv}(K)\mid \mathcal{O}_w\subset\mathcal{O}_v \} \to \operatorname{Spv}k(v),\ w\mapsto w\mod v\]
If $w\in\operatorname{Spv}_\text{rd}^{(i)}(K)$ for some $i\geq 1$ then there exists a unique $v(w)\in\operatorname{Spv}_\text{rd}^{(i-1)}(K)$ such that $\mathcal{O}_w\subset\mathcal{O}_v$. $w$ is henselian if and only if $v$ and $w\mod v$ are henselian.
\end{lemma}

\paragraph{} Let $K$ be a finitely generated field of characteristic $0$ and dimension $2$.

\begin{lemma}\label{2.2}
Let $K$ be henselian with respect to two different valuations $w_1,w_2\in |\operatorname{Spv}(K)|$. Then $K$ is algebraically closed or $w_1,w_2\in\operatorname{Spv}_\text{rd}^{(2)}(K),\ v(w_1)=v(w_2)$ and $k(v(w_1))$ is separably closed. Furthermore, we have $\operatorname{cd}(G_K)\leq 2$.
\end{lemma}

\begin{proof}
Assume that $K$ is not algebraically closed, i.e. $G_K\neq 1$ and set $v_i = v(w_i)$. By Lemma~\ref{2.2-pre} $K$ is henselian with respect to both $v_1$ and $v_2$. If $v_1\neq v_2$, by the Theorem of F.K. Schmidt we have $G_{v_1}\cap G_{v_2} = 1 \neq G_K$, a contradiction. Therefore $v_1 = v_2$.

Now $k(v_1) = k(v_2)$ is henselian with respect to both $w_1\mod v_1$ and $w_2\mod v_2$. Again by the Theorem of F.K. Schmidt we get $G_{k(v_1)} = 1$, hence $k(v_1)$ is separably closed.

The second assertion follows from the first and from [K2], ยง5, Theorem 1.
\end{proof}

\begin{definition}
Let $K$ be finitely generated. A \textit{model} of $K$ is a regular, proper scheme $\mathfrak{X}$ over $\mathbb{Z}$ with function field $K$. A \textit{morphism of models} is a morphism of schemes inducing the identity on $K$. We denote the category of models of $K$ by $\mathfrak{M}(K)$; it is filtered. 

For every model $\mathfrak{X}$ there is a canonical map $\pi_\mathfrak{X}:\operatorname{Spv}(K)\to\mathfrak{X}$. $\pi_\mathfrak{X}(v)$  is the unique point of $\mathfrak{X}$ such that $\mathcal{O}_{\mathfrak{X}, \pi_\mathfrak{X}(v)}\subset\mathcal{O}_v$ and the inclusion $\mathcal{O}_{\mathfrak{X}, \pi_\mathfrak{X}(v)}\hookrightarrow \mathcal{O}_v$ is a homomorphism of local rings.
\end{definition}

\iffalse
\begin{lemma}\phantomsection\label{2.3}
\begin{enumerate}[(i)]
\item $\operatorname{Spv}(K)$, together with the maps $\pi_{\mathfrak{X}}$, is the projective limit of topological spaces: 
\[\operatorname{Spv}(K) =\varprojlim_{\mathfrak{X}\in\mathfrak{M}(K)}\mathfrak{X}\]
In particular we have:
\[ |\operatorname{Spv}(K)| =\varprojlim_{\mathfrak{X}\in\mathfrak{M}(K)}|\mathfrak{X}| \]
\item For all $v\in\operatorname{Spv}(K)$ we have:
\[ \mathcal{O}_v = \varinjlim_{\mathfrak{X}\in\mathfrak{M}(K)}\mathcal{O}_{\mathfrak{X},\pi_\mathfrak{X}(v)} \]
\item For $v\in\operatorname{Spv}(K)$ let $K_v$ be the quotient field of a henselization of $\mathcal{O}_v$ and for $\mathfrak{X}\in\mathfrak{M}(K),\ x\in\mathfrak{X}$ let $K_\mathfrak{X}$ be the quotient field of a henselization of $\mathcal{O}_{\mathfrak{X},x}$. Then:
\[ K_v=\varinjlim_{\mathfrak{X}\in\mathfrak{M}(K)}K_{\pi_\mathfrak{X}(v)} \]
\end{enumerate}
\end{lemma}
\fi

\begin{lemma}\label{2.4}
Let $\ell\neq 2$ be a prime. The following map, induced by the restrictions, is injective:
\[ \mathrm{H}^3(K,\mathbb{Z}/\ell\mathbb{Z})\to\prod_{w\in |\operatorname{Spv}(K)| }\mathrm{H}^3(K_w,\mathbb{Z}/\ell\mathbb{Z}) \]
\end{lemma}

\begin{proof}
The degree $[K(\mu_\ell, \sqrt{-1}):K]$ is prime to $\ell$, thus we can assume that $\mu_\ell\subset K$ and $K$ is not formally real with a usual norm argument. Now we can replace $\mathbb{Z}/\ell\mathbb{Z}$ by $\mathbb{Z}/\ell\mathbb{Z}(2) = \mu_\ell^{\otimes 2}$.

We write $\mathrm{H}^3(L) = \mathrm{H}^3(L, \mathbb{Z}/\ell\mathbb{Z}(2))$. Let $\mathfrak{X}$ be a model of $K$. $\mathfrak{X}_i$ denotes the set of points $x\in\mathfrak{X}$ whose closure $\overline{\{x\}}$ is $i$-dimensional. For $x\in\mathfrak{X}_1$ the local ring $\mathcal{O}_{\mathfrak{X}, x}$ is a discrete valuation ring and defines a valuation $v_x\in\operatorname{Spv}_\text{d}^{(1)}(K)$. By [K1] Theorem 0.8, the following map
\[ \mathrm{H}^3(K)\longrightarrow \prod_{x\in\mathfrak{X}_1}\mathrm{H}^3(K_{v_x}) \]
is injective and its image is contained in $\bigoplus \mathrm{H}^3(K_{v_x})$. By [K1] Lemma 1.4, for a discrete valuation $v$ of $K$ the map
\[ \mathrm{H}^3(K_v) \longrightarrow \prod_w\mathrm{H}^3(K_w) \]
where $w$ ranges over all rank-$2$ valuations with $v(w) = v$, can be identified with the following map:
\[ {}_\ell\operatorname{Br}(k) \longrightarrow \prod_{\tilde{w}\in\operatorname{Spv}^{(1)}(k)} {}_\ell\operatorname{Br}(k_{\tilde{w}}) \]
where $k = k(v)$. This map is injective by the classical Hasse principle and its image is contained in $\bigoplus {}_\ell\operatorname{Br}(k_{\tilde{w}})$. Combining these maps yields the injection:
\[ \mathrm{H}^3(K)\longrightarrow \bigoplus_{x\in\mathfrak{X}_1}\  \bigoplus_{\substack{w\in\operatorname{Spv}_\text{rd}^{(2)}(K) \\ v(w) = v_x}} \mathrm{H}^3(K_w) \]
The direct sum ranges over a subset of $|\operatorname{Spv}(K)|$, thus concludes the proof.
\end{proof}

\begin{lemma}\label{2.5}
Let $K$ be henselian with respect to $w\in|\operatorname{Spv}(K)|$. Set $k=k(w)$ and $\Gamma = \Gamma_w$. Then $k$ is an algebraic extension of a finite field $\mathbb{F}_p$. Let $\ell\neq p$ be a prime and assume $\mu_\ell\subset K$. Then the following conditions are equivalent:
\begin{enumerate}[(i)]
\item $\mathrm{H}^3(K,\mathbb{Z}/\ell\mathbb{Z})=\mathbb{Z}/\ell\mathbb{Z}$
\item $\ell^\infty\nmid[k:\mathbb{F}_p]$ and $\dim_{\mathbb{F}_\ell}(\Gamma/\ell\Gamma) = 2$
\end{enumerate}
Otherwise we have $\mathrm{H}^3(K,\mathbb{Z}/\ell\mathbb{Z})=0$. If $L/K$ is an algebraic extension and (i) holds, we have:
\[ \mathrm{H}^3(L,\mathbb{Z}/\ell\mathbb{Z}) = \begin{cases}
\mathbb{Z}/\ell\mathbb{Z}, & \ell^\infty\nmid [L:K]\\
0, & \text{otherwise}
\end{cases} \]
\end{lemma}

\begin{proof}
Let $G_\ell$ be an pro-$\ell$-Sylow group of $G_K$. By the ramification theory for general valuations ([E], ยง20) we have $G_\ell\cong\mathbb{Z}_\ell(1)^r\rtimes G_k(\ell)$ where the action is defined via the cyclotomic character and $r = \dim_{\mathbb{F}_\ell}(\Gamma/\ell\Gamma)$. In particular, $r\leq 2$ and $G_k(\ell)$ is the pro-$\ell$-Sylow group of $G_k$ hence $G_k(\ell)\cong \mathbb{Z}_\ell$ or $G_k(\ell) \cong 1$.

Let $G_K(\ell)$ be the maximal pro-$\ell$-quotient of $G_K$. Since $\mu_\ell\subset K$, the action of $G_k$ on the pro-$\ell$-Sylow group of the inertia group of $w$ factors through $G_k(\ell)$. We see that the canonical projection $G_K\to G_K(\ell)$ is an isomorphism. Therefore we have:
\[ \mathrm{H}^3(K,\mathbb{Z}/\ell\mathbb{Z}) \cong\mathrm{H}^3(G_K(\ell),\mathbb{Z}/\ell) \cong\mathrm{H}^3(G_\ell,\mathbb{Z}/\ell\mathbb{Z}) \]
Now the equivalence of (i) and (ii) follows from [Se], Ch. I, ยง4.

The second assertion follows from the first one, applied to $L$, by using the following equation of supernatural numbers ([E], Theorem 20.21):
\[ [L:K] = (\Gamma':\Gamma) \cdot [k':k]\cdot p^d \]
for some $d \leq \infty$, where $\Gamma'$ denotes the value group and $k'$ the residue field of the unique prolongation of $w$ to $L$.
\end{proof}

\begin{proposition}\label{2.6}
Let $K_0/K$ be an algebraic extension.
\begin{enumerate}[(i)]
\item Suppose there exists a prime number $\ell$ with $\ell^\infty\nmid[K_0:K]$ and such that for every algebraic extension $L/K_0$ we have: 
\[ \mathrm{H}^3(L,\mathbb{Z}/\ell\mathbb{Z}) = \begin{cases}
\mathbb{Z}/\ell\mathbb{Z}, & \ell^\infty\nmid [L:K_0]\\
0, & \text{otherwise}
\end{cases} \]
Then there exists a unique henselian $w\in|\operatorname{Spv}(K)|$.
\item Assume that (i) is satisfied for two different prime numbers. Then $w$ is a defectless valuation.
\end{enumerate}
\end{proposition}

\begin{proof}
\begin{enumerate}[(i)]
\item Since $\mathrm{H}^3(K_0, \mathbb{Z}/\ell\mathbb{Z})\neq 0$ by assumption, according to Lemma \ref{2.4} we can find a valuation $w_0\in|\operatorname{Spv}(K_0)|$ such that:
\[ \mathrm{H}^3((K_0)_{w_0}, \mathbb{Z}/\ell\mathbb{Z}) \neq 0 \]
By requirement $\ell^\infty \nmid [(K_0)_{w_0} : K_0]$. By replacing $K_0$ by $(K_0)_{w_0}$, we can assume that $w_0$ is henselian.

Assume that $w = w_0|_K$ is not henselian. Then there exists a $w_1\in|\operatorname{Spv}(K_0)|$ with $w_1\neq w_0$ and such that $w = w_1|_K$, for otherwise $w$ would have a unique prolongation to $K_0$ and hence to $\overline{K}$ since $w_0$ is henselian.

Let $(K_0)_{w_1}$ be a henselization of $K_0$ with respect to $w_1$ and let $K_w$ be a henselization of $K$ with respect to $w$ in $(K_0)_{w_1}$. Then $(K_0)_{w_1}$ is the composite of $K_0$ and $K_w$ and we have $\ell^\infty\nmid [(K_0)_{w_1} : K_w]$.

Since $K_0$ is henselian with respect to $w_0$, a conjugate $\tau(K_w)$ for some $\tau\in G_K$ of $K_w$ lies in $K_0$, hence $\ell^\infty\nmid [K_w : K]$ as well. Consequently, $\ell^\infty \nmid [(K_0)_{w_1} : K]$ and therefore $\ell^\infty \nmid [(K_0)_{w_1} : K_0]$. By requirement, $\mathrm{H}^3((K_0)_{w_1}, \mathbb{Z}/\ell\mathbb{Z}) \neq 0$.

Now $(K_0)_{w_1}$ is henselian both with respect to $w_1$ and with respect to the prolongation of $w_0$. Lemma \ref{2.2} yields $\operatorname{cd}(G_{(K_0)_{w_1}})\leq 2$, a contradiction. The uniqueness of $w$ is again a consequence of Lemma \ref{2.2}.
\item Choose the prime $\ell$ different from $\operatorname{char} k(w)$. According to Lemma \ref{2.5} we have $\operatorname{rrank}(w)=\dim_\mathbb{Q}(\Gamma_w\otimes_\mathbb{Z}\mathbb{Q} )\geq \dim_{\mathbb{F}_\ell}(\Gamma_w /\ell\Gamma_w) = 2 = \dim(K)$. By Lemma \ref{rank-dimension-inequality}, this inequality is actually an equality.
\end{enumerate}
\end{proof}

\section{Local Correspondence}

Let $K,K'$ be two finitely generated fields of characteristic $0$ and dimension $2$ and $\sigma:G_K\to G_{K'}$ be an isomorphism of profinite groups. For intermediate fields $L$ of $\overline{K}/K$ we denote the corresponding intermediate field of $\overline{K'}/K'$ by $L'$. In other words $\sigma G_L=G_{L'}$.

\begin{lemma}\label{3.1}
Let $w\in\operatorname{Spv}_\text{d}^{(2)}(K)$ and let $E=K_w$ be a henselization of $w$. Then $E'$ is a henselization of $K'$ with respect to a unique $w'\in\operatorname{Spv}_\text{d}^{(2)}(K')$. The map $w\mapsto w'$ does not depend on the choice of the henselization.
\end{lemma}

\begin{proof}
Let $\ell_1,\ell_2$ be two different prime numbers different from $\operatorname{char} k(w)$ and let $E_0 = E(\mu_{\ell_1\ell_2})$. Then $E_0/E$, and also $E'_0/E'$, satisfies the condition of \ref{2.6} (ii). Thus there exists a unique henselian defectless valuation $w'_{E'}$ of $E'$, so $E'$ contains a henselization $K'_{w'}$ of $w' = w'_{E'}|_{K'}$. By applying the same argument to $\sigma^{-1}$ we find that $E' = K'_{w'}$.

Let $F$ be another henselization of $w$. Then $E, F$ are $K$-isomorphic, hence $E',F'$ are $K'$-isomorphic and the corresponding henselian valuations of $E', F'$ respectively are mapped to each other.
\end{proof}

\begin{lemma}\label{3.2}
$\sigma$ induces a bijection $\sigma:\operatorname{Spv}_\text{d}^{(1)}(K) \to\operatorname{Spv}_\text{d}^{(1)}(K')$. If $E=K_v\subset\overline{K}$ is a henselization of $K$ with respect to $v\in\operatorname{Spv}_\text{d}^{(1)}(K)$, then $E'$ is a henselization of $K'$ with respect to $v'=\sigma(v)$. Furthermore, if $E^{\text{t}}$ and $E'^{\text{t}}$ denote the inertia fields of $E$ and $E'$ respectively, then $\sigma$ induces an isomorphism:
\[ G_{k(v)}\cong\operatorname{Gal}(E^\text{t}/E) \to\operatorname{Gal}(E'^{\text{t}}/E')\cong G_{k(v')} \]
which is induced by a unique isomorphism $\varphi_v^\text{s}:k(v')^\text{s}\to k(v)^\text{s}$. In particular $\varphi_v=\varphi_v^\text{s}|_{k(v')}:k(v')\to k(v)$ is an isomorphism.
\end{lemma}

\begin{proof}
Lemma \ref{3.1} shows that $\sigma$ induces a bijection $\sigma: \operatorname{Spv}_\text{d}^{(2)}(K)\to \operatorname{Spv}_\text{d}^{(2)}(K')$. For all $v\in\operatorname{Spv}(K)$ we choose a fixed henselization $K_v\subset\overline{K}$, such that if $v,w\in\operatorname{Spv}(K)$ and $w$ is a specialization of $v$ we have $K_v\subset K_w$. This means that if $v$ is nontrivial, we get $w\in\operatorname{Spv}_\text{rd}^{(2)}(K)$ and $v=v(w)\in\operatorname{Spv}_\text{d}^{(1)}(K)$. We set $K'_{\sigma(w)} = (K_w)'$ for $w\in\operatorname{Spv}_\text{d}^{(2)}(K)$. This implies that $K'_{\sigma(w)}$ is a henselization of $K'$ with respect to $\sigma(w)$.

Let $w_1,w_2 \in\operatorname{Spv}_\text{d}^{(2)}(K)$ be two different valuations. By Lemma \ref{2.2} the following assertions are equivalent:
\begin{enumerate}[(i)]
\item The composite $K_{w_1}K_{w_2}$ is not algebraically closed.
\item $w_1,w_2\in\operatorname{Spv}_\text{rd}^{(2)}(K)$ and $v(w_1) = v(w_2)$.
\end{enumerate}
In this case, $K_{w_1}K_{w_2}$ is the inertia field $K_v^\text{t}$ of $K_v$ where $v=v(w_1)$. Furthermore, $K'_{\sigma(w_1)}K'_{\sigma(w_2)} = (K_{w_1}K_{w_2})' \neq \overline{K'}$ and again by Lemma \ref{2.2} we get: \[\sigma(w_1),\sigma(w_2)\in\operatorname{Spv}_\text{rd}^{(2)}(K)\quad \text{and} \quad v(\sigma(w_1)) = v(\sigma(w_2))\]
Thus $\sigma: \operatorname{Spv}_\text{d}^{(2)}(K)\to \operatorname{Spv}_\text{d}^{(2)}(K')$ maps $\operatorname{Spv}_\text{rd}^{(2)}(K)$ onto $\operatorname{Spv}_\text{rd}^{(2)}(K')$ such that:
\[ v(w_1)=v(w_2) \iff v(\sigma(w_1)) = v(\sigma(w_2)) \]
This shows that $\sigma$ also induces a bijection $\sigma:\operatorname{Spv}_\text{d}^{(1)}(K)\to\operatorname{Spv}_\text{d}^{(1)}(K')$ and for all $w\in\operatorname{Spv}_\text{rd}^{(2)}(K)$ it holds $\sigma(v(w)) = v(\sigma(w))$.

Let $v\in\operatorname{Spv}_\text{d}^{(1)}$ and let $N$ be the normal subgroup of $G_{K_v}$ generated by all subgroups $G_{K_w}$ for $w\in\operatorname{Spv}_\text{rd}^{(2)}(K)$ with $v(w) = v$. Since a global field has no non-trivial algebraic extension in which every prime splits completely, we get $N=G_{K_v}$. This shows that $K'_{v'} = (K_v)'$ is a henselization of $K'$ with respect to $v'=\sigma(v)$. Furthermore, let $w_1,w_2\in\operatorname{Spv}_\text{rd}^{(2)}(K)$ with $w_1\neq w_2$ and $v=v(w_1)=v(w_2)$, then:
\[ \sigma(G_{K^\text{t}_v}) = \sigma(G_{K_{w_1}}\cap G_{K_{w_2}}) = G_{K'_{w'_1}}\cap G_{K'_{w'_2}} = G_{(K')^\text{t}_{v'}} \]
Therefore, $\sigma$ induces an isomorphism:
\[ G_{k(v)} \cong G_{K_v}/G_{K_v^\text{t}} \to G_{K'_{v'}}/G_{(K')_{v'}^\text{t}}\cong G_{k(v')} \]
The rest follows from the Theorem of Neukirch-Uchida.
\end{proof}

\begin{remark}\label{3.3}
If $L\subset M$ are intermediate fields of $\overline{K}/K$, which are finite over $K$, then $\sigma$ also induces bijections
\[ \operatorname{Spv}_\text{d}^{(1)}(L) \to \operatorname{Spv}_\text{d}^{(1)}(L'),\qquad \operatorname{Spv}_\text{d}^{(1)}(M) \to \operatorname{Spv}_\text{d}^{(1)}(M') \]
such that the following diagram commutes:
\[\begin{tikzcd}
\operatorname{Spv}_\text{d}^{(1)}(M) \rar["\sigma"]\dar & \operatorname{Spv}_\text{d}^{(1)}(M')\dar\\
\operatorname{Spv}_\text{d}^{(1)}(L) \rar["\sigma"'] & \operatorname{Spv}_\text{d}^{(1)}(L')
\end{tikzcd}\]
where the vertical maps are restrictions. Let $w\in\operatorname{Spv}_\text{d}^{(1)}(M),\ v=w|_L$ and $w'=\sigma(w),\ v'=\sigma(v)$. Then the following diagram commutes:
\[ \begin{tikzcd}
k(w') \rar["\varphi_w"] & k(w)\\
k(v') \rar["\varphi_v"']\uar[hook] & k(v)\uar[hook]
\end{tikzcd} \]
By limit process we see that $\sigma$ induces a bijection $\sigma: \operatorname{Spv}_\text{d}^{(1)}(\overline{K})\to \operatorname{Spv}_\text{d}^{(1)}(\overline{K'})$. Let $\overline{v}\in \operatorname{Spv}_\text{d}^{(1)}(\overline{K})$ and $G_{\overline{v}}\subset G_K$ be the decomposition group of $\overline{v}$. Then we have $\sigma(G_{\overline{v}}) = G_{\sigma(\overline{v})}$. Now it is easy to see that for every $g\in G_K$:
\[ \sigma(g\overline{v}) = \sigma(g)\sigma(\overline{v}) \]
\end{remark}

\section{Global Correspondence mod $n$}

\begin{theorem}[\textit{Hilbert's Irreducibility Theorem}]\label{hilberts-irreducibility-theorem}
Inhalt...
\end{theorem}

\begin{lemma}\label{4.1}
Let $E$ be a number field and let $X$ be a smooth projective geometrically connected curve over $E$. Let $\pi:X'\to X$ be a connected Galois covering of degree $d$ which splits completely, i.e. every closed point $P\in X_0$ has exactly $d$ pre-images in $X'$. Then $d=1$.
\end{lemma}

\begin{proof}
Let $f: X\to\mathbf{P}^1_E$ be a non-constant morphism and let $f' =  f\circ \pi: X'\to\mathbf{P}^1_E$. By Hilbert's Irreducibility Theorem \ref{hilberts-irreducibility-theorem} there exists a closed $E$-rational point $P$ of $\mathbf{P}^1_E$ which has only one pre-image under $f'$. Consequently, $P$ only has one pre-image under $f$, say $P'$, and $P'$ has only one pre-image under $\pi$.
\end{proof}

\paragraph{} Let $k$ and $k'$ be the algebraic closures of $\mathbb{Q}$ in $K$ and $K'$ respectively, i.e. the constant fields of $K$ and $K'$, and let $\overline{k}$ and $\overline{k'}$ be the algebraic closure of $k$ and $k'$ in $\overline{K}$ and $\overline{K'}$ respectively.

Let $X$ and $X'$ be the unique smooth projective curves over $k$ and $k'$ with function field $K$ and $K'$ respectively. We identify the set of closed points $X_0$ of $X$ with the set of valuations $v\in\operatorname{Spv}_\text{d}^{(1)}(K)$ with $\operatorname{char} k(v)=0$ and similarly identify $X'_0$ with the corresponding subset of $\operatorname{Spv}_\text{d}^{(1)}(K')$. 

By Lemma \ref{3.2} $\sigma$ induces a bijection $\sigma: X_0\to X'_0$ and for any $P\in X_0$ an isomorphism $\varphi_P: k(\sigma(P))\to k(P)$.

\begin{lemma}\label{4.2-pre}
We have $[k:\mathbb{Q}] = [k':\mathbb{Q}]$.
\end{lemma}

\begin{proof}
First we suppose that $k/\mathbb{Q}$ is a Galois extension and $X$ has a $k$-rational point $P_0$. We can consider $k'$ as a subfield of $k$ via: 
\[\begin{tikzcd}
k'\ar[r] & k(\sigma(P_0))\ar[r, "\varphi_{P_0}"', "\cong"] & k(P_0) \ar[r, "\cong"] & k
\end{tikzcd}\]
For all $P' = \sigma(P)\in X'_0$ we also get an embedding:
\[ \begin{tikzcd}
k \ar[r] & k(P) \ar[r, "\varphi_P^{-1}"', "\cong"] & k(P')
\end{tikzcd} \]
We see any embedding $k\to \overline{k(P')}$ maps $k$ into $k(P')$ because $k/\mathbb{Q}$ is Galois. Thus we have for all $P'\in X'_0$:
\[ k\otimes_{k'} k(P')\cong \prod_{\operatorname{Hom}_{k'}(k, k(P'))} k(P') \]
in which case $X'_k\to X'$ splits completely. By Lemma \ref{4.1} we get $k\cong k'$, hence $[k:\mathbb{Q}]= [k':\mathbb{Q}]$.

Now we drop the assumption that $k/\mathbb{Q}$ is Galois. There exists a finite extension $k_1/k$ such that $k_1/\mathbb{Q}$ is Galois and $X(k_1)\neq\varnothing$. Let $K_1 = Kk_1$ be the constant field extension of $K$ with $k_1$ and let $k'_1$ be the constant field of $K'_1$. Applying the above argument to $K_1$ and $K'_1$ yields $[k_1:\mathbb{Q}] = [k'_1:\mathbb{Q}]$. Therefore:
\begin{align*}
[k:\mathbb{Q}] &= [k_1:\mathbb{Q}]\cdot [K_1:K]^{-1} = [k'_1:\mathbb{Q}]\cdot [K'_1:K']^{-1}\\
&= [k'_1:\mathbb{Q}]\cdot ([K'_1: K'k_1'] \cdot [K'k_1':K'])^{-1}\\
&= [k'_1:\mathbb{Q}]\cdot  ([K'_1: K'k_1'] \cdot [k'_1:k'])^{-1} \leq [k'_1:\mathbb{Q}]\cdot [k'_1:k']^{-1} = [k':\mathbb{Q}]
\end{align*}
By symmetry, we get $[k:\mathbb{Q}] = [k':\mathbb{Q}]$.
\end{proof}

\begin{lemma}\label{4.2}
We have $(K\overline{k})'=K'\overline{k'}$, i.e. $\sigma(G_{K\overline{k}})=G_{K'\overline{k'}}$. $\sigma$ induces an isomorphism $G_k\to G_{k'}$ such that the following diagram commutes:
\[ \begin{tikzcd}
G_K \ar[r, "\sigma"] \ar[d] & G_{K'}\ar[d]\\
G_k \ar[r, "\sigma"'] & G_{k'}
\end{tikzcd} \]
Moreover, $\sigma:G_k\to G_{k'}$ is induced by a unique isomorphism $\varphi:\overline{k'}\to\overline{k}$.
\end{lemma}

\begin{proof}
Let $L/K$ be a finite subextension of $\overline{K}/K$. Let $\ell$ and $\ell'$ be the constant fields of $L$ and $L'$ respectively. Applying Lemma \ref{4.2-pre} to $K$ and $L$ gives:
\[ [\ell:k] = [\ell':k'] \]
Therefore $L/K$ is a constant field extension iff $L'/K'$ is a constant field extension. Since $K\overline{k}/K$ and $K'\overline{k'}/K$ are the union of their finite subextensions, we obtain $(K\overline{k})' = K'\overline{k'}$. This implies that $\sigma$ induces an isomorphism:
\[G_k \cong \operatorname{Gal}(K\overline{k}/K) \to \operatorname{Gal}(K'\overline{k'}/K')\cong G_{k'}\] 
Everything else follows from Neukirch-Uchida \ref{thm:neukirch-uchida}.
\end{proof}

\begin{remark}
Consider $\overline{K}'' = \overline{K}'\otimes_{\overline{k'}}\overline{k}$ via the isomorphism $\varphi: \overline{k'}\to \overline{k}$. If we replace $\sigma: G_K\to G_{K'}$ with the composition
\[ \begin{tikzcd}
G_K \ar[r, "\sigma"] & G_{K'} \ar[r] & G_{K'}
\end{tikzcd} \]
where the second map is induced by the isomorphism $\overline{K''}\to\overline{K'},\ x\otimes y\mapsto \varphi^{-1}(y)\cdot x$, we may assume that $k=k'$, $\overline{k} = \overline{k'}$ and $\varphi:\overline{k}\to\overline{k}$, $\sigma: G_k\to G_k$ are identities.
\end{remark}

\paragraph{} Let $n\in\mathbb{N}$. In the previous remark, we have determined that the following diagram commutes: 
\[ \begin{tikzcd}
G_K \ar[r]\ar[d, "\sigma"'] & G_k\\
G_{K'}\ar[ru]
\end{tikzcd} \]
Now the operation of $G_K$ and $G_{K'}$ on $\mu_n$ factors through $G_k$, thus we have $\sigma(g)\xi = g\xi$ for all $\xi\in\mu_n$ and $g\in G_K$. Therefore, for all intermediate fields $L$ of $\overline{K}/K$, $\sigma$ induces an isomorphism:
\[ \varphi_n:L'^\times/n \cong\mathrm{H}^1(L', \mu_n) \to \mathrm{H}^1(L,\mu_n) \cong L^\times/n \]
Obviously, for intermediate fields $L\subset M$ of $\overline{K}/K$ the following diagram commutes:
\[ \begin{tikzcd}
L'^\times/n \ar[r, "\varphi_n"]\dar & L^\times/n \dar\\
M'^\times/n \ar[r, "\varphi_n"'] & M^\times/n
\end{tikzcd} \]
Let $P\in X_0$ and $v_P:K\to\mathbb{Z}\cup\{\infty\}$ be the corresponding discrete normalized valuation and let $U_P$ be the group of units of the valuation ring $\mathcal{O}_P$. We denote the natural projection $U_P\to k(P)^\times,\ x\mapsto x\mod P$ by $r_P$. 

Let $n\in\mathbb{N}$. Tensoring the exact sequence $0\to U_P\to K^\times \to\mathbb{Z}\to 0$ with $\mathbb{Z}/n\mathbb{Z}$ preserves its exactness since $\mathbb{Z}$ is $\mathbb{Z}$-flat:
\[ 0\longrightarrow U_P/n\longrightarrow K^\times/n\longrightarrow\mathbb{Z}/n\mathbb{Z}\longrightarrow 0 \]
We'll use the same notation for $P' = \sigma(P)\in X'_0$.

\begin{lemma}\phantomsection\label{4.3}
\begin{enumerate}[(i)]
\item $\varphi_n$ induces an isomorphism $\varphi_n: U_{P'}/n\to U_P/n$.
\item The following diagram commutes:
\[ \begin{tikzcd}
U_{P'}/n \rar["\varphi_n"] \dar["r_{P'}/n"'] & U_P/n \dar["r_P/n"]\\
k(P')^\times/n \rar["\varphi_n"'] & k(P)^\times/n
\end{tikzcd} \]
\end{enumerate}
\end{lemma}

\begin{proof}
\begin{enumerate}[(i)]
\item  We have $(K^\text{t}_P)^\times/n\cong \mathbb{Z}/n\mathbb{Z}$ since $\operatorname{char}k(P) = 0$. The canonical map $K^\times/n \to (K^\text{t}_P)^\times/n$ can be identified with the map $K^\times /n\to\mathbb{Z}/n$ induced by $v_P$. Now the following commutative diagram gives us the result:
\[ \begin{tikzcd}
0 \ar[d] & 0 \ar[d]\\
U_{P'}/n \ar[r, dashed]\ar[d] & U_P/n\ar[d]\\
K'^\times /n \ar[r, "\varphi_n"]\ar[d] & K^\times/n\ar[d]\\
(K^\text{t}_P)'^\times /n \ar[r, "\varphi_n"'] &  (K^\text{t}_P)^\times /n
\end{tikzcd}\]
Note that $(K^\text{t}_P)' = (K'^{\text{t}}_{P'})$ as proven in Lemma \ref{3.2}.
\item Consider the field extension $K_P/K$. Without loss of generality, we can assume $K=K_P$. Then $r_P/n$ is an isomorphism and the composition
\[\begin{tikzcd}
k(P)^\times / n\ar[rr, "(r_P/n)^{-1}"] && U_P/n \ar[r, hook] & K_P^\times/n
\end{tikzcd}\]
is the inflation $\mathrm{H}^1(k(P), \mu_n) \to \mathrm{H}^1(K_P,\mu_n)$. The same holds for $P'$ due to Lemma \ref{3.2}. Therefore, the assertion follows from the commutativity of the following diagram:
\[ \begin{tikzcd}
k(P')^\times/n \ar[r, "\cong"] \ar[d, "\varphi_P/n"'] & \mathrm{H}^1(k(P'),\mu_n) \ar[r, "\mathrm{inf}"] \ar[d]& \mathrm{H}^1(K'_{P'}, \mu_n) \ar[d, "\varphi_n"] \\
k(P)^\times/n \ar[r, "\cong"'] & \mathrm{H}^1(k(P),\mu_n)  \ar[r, "\mathrm{inf}"'] & \mathrm{H}^1(K_{P}, \mu_n)
\end{tikzcd}  \qedhere\]
\end{enumerate}
\end{proof}

\begin{theorem}[\textit{Mordell-Weil Theorem}]\label{mordell-weil-theorem}
Inhalt...
\end{theorem}

\begin{definition}\label{4.4}
For a finite subset $S\subset X_0$ set:
\[ K^S=\{x\in K^\times \mid v_P(x)=0\text{ for all }P\in X_0\setminus S \} \]
$K'^{S'}$ is defined similarly. For finite subsets $S$ of $X_0$, the corresponding subsets of $X_0'$ will be denoted by $S'$, i.e. $S'=\{\sigma P\mid P\in S \} $.
\end{definition}

\begin{lemma}\phantomsection\label{4.5}
\begin{enumerate}[(i)]
\item There exists a finite subset $S\subset X_0$ such that:
\[ \operatorname{Pic}(X\setminus S)=0=\operatorname{Pic}(X'\setminus S') \]
Such a set $S$ is called \textit{admissible}. If $V\subset X$ is an open subscheme, then one can choose $S$ in $V_0$.
\item Let $S$ be admissible. For all $n\in\mathbb{N}$ the following canonical maps are injective:
\[ K^S/n \to K^\times /n,\quad K'^{S'}/n\to K'^\times /n \]
$\varphi_n$ induces isomorphisms $\varphi_n: K'^{S'}/n\to K^S/n$.
\end{enumerate}
\end{lemma}

\begin{proof}
\begin{enumerate}[(i)]
\item By Mordell-Weil Theorem \ref{mordell-weil-theorem} the Picard group of $X$ is finitely generated. Let $D_1,\ldots, D_r$ be Weil divisors of $X$ such that the associated line bundles generate $\operatorname{Pic}(X)$ and similarly let $D'_1,\ldots,D'_s$ generate $\operatorname{Pic}(X')$. Clearly any finite $S\subset X_0$ such that
\[ \bigcup_{i=1}^r \operatorname{supp}D_i\subset S\quad\text{and}\quad \bigcup_{j=1}^s\operatorname{supp}D'_j\subset S' \]
is admissible. Now let $V\subset X$ be an open subscheme. By the approximation theorem, we can choose the $D_i$ and the $D'_j$ in $V_0$ and $\sigma (V_0)$ respectively.
\item Observe that the following sequence is exact:
\[ \begin{tikzcd}
0 \ar[r] & K^S \ar[r]& K^\times \ar[r, "\operatorname{div}"]& \displaystyle \bigoplus_{P\in X_0\setminus S}\mathbb{Z} \ar[r]& 0
\end{tikzcd} \]
Since the right module is $\mathbb{Z}$-flat, tensoring with $\mathbb{Z}/n\mathbb{Z}$ yields another exact sequence and we can consider $K^S/n$ as a subgroup of $K^\times/n$. Then:
\[ K^S/n = \bigcap_{P\in X_0\setminus X}U_P/n \]
The analogous result holds for $K'^{S'}/n$. Thus the assertion follows from Lemma \ref{4.3} (i).\qedhere
\end{enumerate}
\end{proof}

\section{The Proof}

\begin{definition}\label{5.1}
An abelian group $A$ is called \textit{free-by-finite} if its torsion subgroup $A_\text{tor}$ is finite and the quotient $A/A_\text{tor}$ is free abelian. $A$ is free-by-finite if and only if $A$ is the direct sum of a finite abelian group and a free abelian group.
\end{definition}

\begin{example}
\begin{itemize}
\item Free or finite abelian groups are free-by-finite.
\item Finitely generated abelian groups are free-by-finite by the structure theorem for finitely generated $\mathbb{Z}$-modules.
\end{itemize}
\end{example}

\begin{lemma}\phantomsection\label{5.2}
\begin{enumerate}[(i)]
\item Let $f: A\to B$ be a homomorphism of abelian groups with finite kernel and cokernel. Then $A$ is free-by-finite iff $B$ is free-by-finite.
\item Let $0\longrightarrow A'\stackrel{i}{\longrightarrow}A\stackrel{p}{\longrightarrow}A''\longrightarrow 0$ be an exact sequence of abelian groups. If $A'$ and $A''$ are free-by-finite, then $A$ is free-by-finite. 
\item Let $0\longrightarrow A'\stackrel{i}{\longrightarrow}A\stackrel{p}{\longrightarrow}A''\longrightarrow 0$ be an exact sequence of abelian groups. If $A$ is free-by-finite, then $A'$ is free-by-finite. Additionally, if $A'$ is finitely generated, then $A''$ is free-by-finite.
\item Let $A$ be free-by-finite. Then $\bigcap_{n\in\mathbb{N}}nA=0$.
\end{enumerate}
\end{lemma}

\begin{proof}
\begin{enumerate}[(i)]
\item Let $B$ be free-by-finite and $K = \ker(f)$. Considering $A/K$ as a subgroup of $B$, we see that $A/K$ is free-by-finite. Since $(A/K)_\text{tor}$ and $K$ are finite, $K' = \{a\in A\mid na\in K \text{ for some }n\in\mathbb{N}\}$ is finite as well, in particular $A_\text{tor}$ is finite. In fact $K'=A_\text{tor}$, since $K\subset A_\text{tor}$. Now consider the surjection $A\to A/K\to (A/K)/(A/K)_\text{tor}$. This map has kernel $K'$, thus inducing an isomorphism from $A/A_\text{tor}$ to a free abelian group.

Now let $A$ be free-by-finite, i.e. $A = A_\text{tor} \oplus F$ for some free abelian group $F$, and $K=\ker(f)$. Since $K\subset A$ is finite, $K$ is actually contained in $A_\text{tor}$. Therefore, we see that $A/K$ is free by finite as well, and by extension, the image $I$ of $f$. Set $m = \#B/I$ and consider the canonical map $B\stackrel{\cdot m}{\to} I \to I/I_\text{tor}$. This map has kernel $\{b\in B \mid mb \in I_\text{tor}\} = B_\text{tor}$, making $B/B_\text{tor}$ isomorphic to a subgroup of the free abelian group $I/I_\text{tor}$. Now both $I_\text{tor}$ and $B_\text{tor}/I_\text{tor} \subset B/I$ are finite, hence $B_\text{tor}$ is finite as well.
\item The exact sequence induces the exact sequence $0 \longrightarrow A'_\text{tor} \longrightarrow A_\text{tor} \longrightarrow A''_\text{tor}$. Since the surrounding groups are finite, $A_\text{tor}$ is finite as well. Using (i) we see that it suffices to show that $A/A_\text{tor}$ is free-by-finite. 

Observe the following commutative diagram with exact rows, where we consider $A'$ as a subgroup of $A$:
\[ \begin{tikzcd}
0 \ar[r]& A'/A'_\text{tor}\ar[r]\ar[d, "f"'] & A/A_\text{tor}\ar[r]\ar[d, "\cong"] & A/(A'+A_\text{tor}) \ar[r]\ar[d, "g"]& 0\\
0 \ar[r] & p^{-1}(A''_\text{tor})/A_\text{tor} \ar[r]& A/A_\text{tor}\ar[r] & A''/A''_\text{tor}\ar[r] & 0
\end{tikzcd} \]
Note that $f$ is injective and $g$ is surjective. Using the snake lemma, we get an isomorphism $\operatorname{coker}(f)\cong \ker(g)$. We have:
\[\ker(g) = \ker( (A/A')/(A_\text{tor}/A'_\text{tor}) \to A''/A''_\text{tor} ) = A''_\text{tor}/(A_\text{tor}/A'_\text{tor})\]
Since $A''_\text{tor}$ is finite, $\operatorname{coker}(f)\cong \ker(g)$ is finite, too. Applying (i) on $f$, we can see that $p^{-1}(A''_\text{tor})/A_\text{tor}$ is free-by-finite. Since $A''/A''_\text{tor}$ is free abelian, the short exact sequence in the second row splits, making $A/A_\text{tor}$ a direct sum of a free-by-finite group and a free group.
\item Subgroups of free-by-finite groups are free-by-finite. Now assume $A'$ is finitely generated. We consider $A'$ as a subgroup of $A$. Let $T=A_\text{tor}$. By replacing $A'$, $A$, $A''$ with $A'/(T\cap A')$, $A/T$, $A''/p(T)$ respectively, we can assume that $A$ is free and $A'$ is free of finite rank. Let $B$ be a basis of $A$. There exists a finite subset $C\subset B$ such that $A'\subset \bigoplus_{b\in C}\mathbb{Z}b$. We get an exact sequence:
\[ 0 \longrightarrow \Big(\bigoplus_{b\in C} \mathbb{Z}b\Big)\Big/A' \longrightarrow A/A' \longrightarrow \bigoplus_{b\in B\setminus C}\mathbb{Z}b \longrightarrow 0 \]
The left abelian group is finitely generated, particularly free-by-finite. The right group is free, hence also free-by-finite. By (ii), $A/A'\cong A''$ is free-by-finite as well.
\item It suffices to prove this assertion for finite groups and for $A=\mathbb{Z}$. For $A$ finite we have $nA = 0$ for $n = \#A$. Since $\mathbb{Z}$ has no nilpotent elements, the intersection of all prime ideals of $\mathbb{Z}$ is already trivial. \qedhere
\end{enumerate}
\end{proof}

\begin{lemma}\label{5.3}
Let $F$ be a number field. Then:
\begin{enumerate}[(i)]
\item $F^\times$ is free-by-finite.
\item Let $F_1,\ldots,F_n$ be finite extensions of $F$. Then $\big(\prod_{i=1}^{n}F_i^\times\big)/F^\times$ is free-by-finite, where $F^\times$ is considered as a subgroup of $\prod_{i=1}^{n}F_i^\times$ via the diagonal embedding.
\end{enumerate}
\end{lemma}

\begin{proof}
\begin{enumerate}[(i)]
\item Let $\mathcal{P}(F)$ be the group of principal ideals of $F$. Consider the following exact sequence:
\[ \begin{tikzcd}
1 \ar[r] & \mathcal{O}_F^\times \ar[r] & F^\times \ar[r]& \mathcal{P}(F) \ar[r] & 1
\end{tikzcd} \]
By Dirichlet's Unit Theorem, $\mathcal{O}_F^\times$ is free-by-finite. $\mathcal{P}(F)$, as a subset of the ideal group of $F$, is free abelian, in particular free-by-finite. The assertion follows from Lemma \ref{5.2} (ii).
\item Consider the following exact sequence:
\[ \begin{tikzcd}
1 \ar[r] & \displaystyle \prod_{i=2}^{n} F_i^\times \ar[r]& \displaystyle \Big(\prod_{i=1}^{n}F_i^\times\Big)\Big/F^\times \ar[r]& F_1^\times/F^\times \ar[r]& 1
\end{tikzcd} \]
The left group is free-by-finite by (i), and by Lemma \ref{5.2} (ii), we only need to prove that the right group is free-by-finite.

Let $\mathcal{P}(F)$ denote the group of principal ideals of $F$, $\mathcal{I}(F)$ the ideal group of $F$, and $\operatorname{Cl}(F) = \mathcal{I}(F)/\mathcal{P}(F)$ the ideal class group of $F$. We have the following exact sequence:
\[ \begin{tikzcd}
1 \ar[r]& \mathcal{O}_{F_1}^\times /\mathcal{O}_F^\times\ar[r] & F_1^\times / F^\times\ar[r] & \mathcal{P}(F_1)/\mathcal{P}(F)\ar[r] & 1
\end{tikzcd} \]
Again by Lemma \ref{5.2} (ii), it suffices to show that $\mathcal{P}(F_1)/\mathcal{P}(F)$ is free-by-finite. Using the snake lemma, we get the following exact sequence:
\[
0 \longrightarrow \ker(f)\longrightarrow \mathcal{P}(F_1)/\mathcal{P}(F)\longrightarrow \mathcal{I}(F_1)/\mathcal{I}(F)
\longrightarrow \operatorname{coker}(f)\longrightarrow 0 \]
where $f:\operatorname{Cl}(F)\to \operatorname{Cl}(F_1)$. Since the class numbers of number fields are finite, according to Lemma \ref{5.2} (i), it suffices to show that $\mathcal{I}(F_1)/\mathcal{I}(F)$ is free-by-finite. This follows from the fact that there are only finitely many primes of $F$ which are ramified in $F_1$.\qedhere
\end{enumerate}
\end{proof}

\begin{lemma}\label{5.4}
Let $S\subset X_0$ be admissible. Then there exists a finite subset $T\subset X_0\setminus S$ such that the following map is injective:
\[ r_{S,T}:K^S \to\prod_{P\in T}k(P)^\times,\ x\mapsto(r_P(x))_{P\in T} \]
In this case, $\operatorname{coker}(r_{S,T})$ is free-by-finite.
\end{lemma}

\begin{proof}
Let $U = X\setminus S$ and $P_1\in U$ be a closed point. We set:
\[ C_1 = \ker(r_{P_1}|_{K^S}: K^S \to k(P_1)^\times) \]
Since $r_{P_1}|_{k^\times}:k^\times \to k(P_1)^\times$ is injective, we have $C_1\cap k^\times = 1$ and the following map is injective:
\[ C_1 \to\prod_{P\in S}\mathbb{Z},\ x \mapsto (v_P(x))_{P\in S} \]
Therefore, $C_1$ is a free abelian group of finite rank. If $C_1 = 1$, then we set $T = \{P_1\}$ and we are done. Otherwise, let $x\in C_1,\ x\neq 1$. Then there exists an $a\in k^\times$ with the following properties:
\begin{enumerate}[(i)]
\item There exists a point $P_2\in X_0\setminus(S\cup\{P_1\})$ which lies above the prime of $k(x)$ corresponding to the polynomial $x-a\in k[x]$.
\item $a$ is not a root of unity.
\end{enumerate}
We set $C_2 = \ker(r_{P_2}|_{C_1})\subset C_1$. $C_2$ is free abelian of finite rank as well. By requirement $r_{P_2}(x)=a$ and $a\in k^\times$ is not of finite order. It follows $\operatorname{rank}(C_2) < \operatorname{rank}(C_1)$. By repeating this process until $C_r=1$, we get points $P_2,\ldots,P_r\in U_0$, such that the following map is injective:
\[ C_1\to\prod_{i=2}^{r} k(P_i),\ x\mapsto(r_{P_i}(x))_i \]
Finally for $T=\{P_1,\ldots,P_r\}$, the map $r_{S,T}$ is injective. For the second assertion, note that:
\[ \operatorname{coker}(r_{S,T}) \cong\operatorname{coker}\Big(K^S/k^\times \to \prod_{P\in T}k(P)^\times /k^\times \Big) \]
Since $K^S/k^\times$ is finitely generated, Lemma \ref{5.2} (iii) and Lemma \ref{5.3} (ii) show that the latter group is free-by-finite.
\end{proof}

\begin{definition}
For each admissible $S\subset X_0$ and $T_1\subset X_0\setminus S$ with injective $r_{S,T_1}$ we also have the injectivity of $r_{S,T_2}$ for every $T_1 \subset T_2$. Therefore,  we can find a finite subset $T\subset X_0\setminus S$ such that both $r_{S,T}$ and $r_{S',T'}$ are injective. Such a $T$ will be called $S$-\textit{admissible} and $(S,T)$ is called \textit{admissible pair}.
\end{definition}

\begin{theorem}[\textit{Pop}]\label{1.1}
Let $K,K'$ be two finitely generated fields of characteristic $0$ and dimension $2$. Suppose there is an isomorphism $\sigma:G_K\to G_{K'}$ between their absolute Galois groups, then there exists a unique field isomorphism $\varphi:\overline{K'}\to\overline{K}$ with $\sigma(g)=\varphi^{-1}g\varphi$ for all $g\in G_K$. In particular $\varphi$ induces a field isomorphism $\varphi:K'\to K$.
\end{theorem}

\begin{step}
There exists a unique group isomorphism $\varphi:K'^\times\to K^\times$ such that for any $P\in X_0$ we have $\varphi(U_{P'})=U_P$ where $P'=\sigma(P)$ and the following diagram commutes:
\[ \begin{tikzcd}
U_{P'} \ar[r, "\varphi"]\ar[d, "r_{P'}"'] & U_P \ar[d, "r_P"]\\
k(P')^\times \ar[r, "\varphi_P"'] & k(P)^\times
\end{tikzcd} \]
\end{step}

\begin{proof}
Since any rational function on $X$ is uniquely determined by its values at those points where it is defined, $\varphi$ is unique. In other words, the following maps are injective for all finite subsets $S\subset X_0$:
\[ r_S:K^S \to\prod_{P\in X_0\setminus S} k(P)^\times,\ x\mapsto (r_P(x))_P \]
For existence, let $(S,T)$ be an admissible pair. First, we show that there is a unique homomorphism $\varphi^{S,T}$, making the following diagram commutative:
\[ (\star) \qquad \begin{tikzcd}
K'^{S'} \rar["\varphi^{S,T}", dashed] \dar["r_{S',T'}"'] & K^S \dar["r_{S,T}"]\\
\displaystyle \prod_{P\in T}k(\sigma P)^\times \rar["\prod\varphi_P"'] & \displaystyle \prod_{P\in T}k(P)^\times
\end{tikzcd} \phantom{\qquad (\star)} \]
The vertical maps are injective by definition. Thus, it suffices to show that the composition $\varrho:K'^{S'}\to\prod k(\sigma P)^\times\to \prod k(P)^\times\to\operatorname{coker}(r_{S,T})$ is trivial. Consider the commutative diagram which results from tensoring $(\star)$ with $\mathbb{Z}/n\mathbb{Z}$:
\[ \begin{tikzcd}
K'^{S'}/n \rar[dashed]\dar & K^S/n\dar\\
\displaystyle \prod_{P\in T}k(\sigma P)^\times/n \rar & \displaystyle \prod_{P\in T}k(P)^\times/n
\end{tikzcd} \]
According to Lemma~\ref{4.3} and Lemma~\ref{4.5} (ii) this diagram can now be completed by $\varphi_n: K'^{S'}/n\to K^S/n$. This implies $\varrho/n=0$, i.e. $\operatorname{im}(\varrho)\subset n\operatorname{coker}(r_{S,T})$ for every $n\in\mathbb{N}$. By Lemma~\ref{5.2} (iii) and Lemma~\ref{5.4} it follows $\varrho = 0$. By symmetry, $\varphi^{S,T}$ is an isomorphism.

Let $T_1, T_2\subset X_0\setminus S$ be two $S$-admissible subsets and suppose $T_1\subset T_2$. By considering $(\star)$ we find:
\[ r_{S,T_1}\circ\varphi^{S,T_2}=\Big(\prod_{P\in T_1}\varphi_P\Big)\circ r_{S',T_1'} = r_{S,T_1}\circ\varphi^{S,T_1} \]
Since $r_{S,T_1}$ is injective we get $\varphi^{S,T_2}=\varphi^{S,T_1}$. Hence, $\varphi^{S,T}$ is actually independent of $T$, thus we can omit the $T$ from its notation. Now if $T$ ranges over all $S$-admissible subsets of $X_0$, then $(\star)$ shows:
\[ r_S\circ\varphi^S = \Big(\prod_{P\in X_0\setminus S}\varphi_P \Big)\circ r_{S'} \]
In other words, we can replace $T$ by $X_0\setminus S$ in $(\star)$. If $S_1\subset S_2$ are two admissible subsets, then:
\[ r_{S_2}\circ\varphi^{S_2}|_{K'^{S'_1}} = \Big(\prod_{P\in X_0\setminus S_2}\varphi_P \Big)\circ r_{S'_2}|_{K'^{S'_1}} = r_{S_2}\circ\varphi^{S_1} \]
Hence, $\varphi^{S_1}=\varphi^{S_2}|_{K'^{S'_1}}$. Thus, we can combine the isomorphisms $\varphi^S$, where $S$ ranges over the admissible subsets of $X_0$, into an isomorphism $\varphi = \varinjlim \varphi^S: K'^\times \to K^\times$. 

Note that for every $x\in K^\times$ we have $v_P(x)= 0$ for almost all $P\in X_0$; similarly for $K'$ and $X'_0$. By Lemma \ref{4.5} (i) we can find an admissible set $S\subset X_0\setminus \{P\}$ such that $x\in K'^{S'}$ for any $x\in U_{P'}$.
\end{proof}

\begin{step}
Extending $\varphi$ to a map $K'\to K$ by setting $\varphi(0)=0$ yields a field isomorphism $\varphi:K'\to K$.
\end{step}

\begin{proof}
Observe $\varphi(-1)^2 = \varphi(1) = 1$, and since $\varphi$ is bijective on $K'^\times$, it follows $\varphi(-1) \neq 1$ and hence $\varphi(-1) = -1$. Now, to prove the assertion, it suffices to show $\varphi(x + y) = \varphi(x) + \varphi(y)$ for all $x,y\in K'^\times$.
\begin{itemize}
\item \textit{Case 1:} If $x + y = 0$, we have:
\[ \varphi(x + y) = 0 = \varphi(x) + \varphi(-1)\varphi(x) = \varphi(x) + \varphi(-x) = \varphi(x) + \varphi(y) \]
\item \textit{Case 2:} Let $x + y\neq 0$ and $S\subset X_0$ be a finite subset such that $\varphi(x + y)$, $\varphi(x)$ and $\varphi(y)$ are contained in $K^S$. Looking at the commutative diagram in \mbox{Step 1} we get
\begin{align*}
r_P(\varphi(x+ y)) &= \varphi_P(r_{P'}(x + y)) \\
&= \varphi_P(r_{P'}(x)) + \varphi_P(r_{P'}(y)) = r_P(\varphi(x) + \varphi(y))
\end{align*}
for all $P\in X_0\setminus S$. Note that $\varphi_P: k(P')\to k(P)$ is a field isomorphism and that the residue maps $r_{P}: \mathcal{O}_{P} \to k(P)$ are ring homomorphisms. Since $K^S\to \prod_{P\in X_0\setminus S} k(P)^\ast$ is injective, we get $\varphi(x+y) = \varphi(x) + \varphi(y)$.\qedhere
\end{itemize}
\end{proof}

\begin{remark}
For any finite subextension $L/K$ of $\overline{K}/K$ there exists an isomorphism $\varphi_L: L'\to L$. If $K\subset L\subset M$ are finite subextensions, we have $\varphi_M|_{L'} = \varphi_{L'}$, since $r_Q(\varphi_M(x)) = r_Q(\varphi_L(x))$ for all $x\in L'^\times$ and almost all $Q\in (X_M)_0$. By passing to limits we obtain an isomorphism $\varphi: \overline{K}'\to \overline{K}$.
\end{remark}

\begin{step}
$\varphi$ induces $\sigma:G_K\to G_{K'}$, i.e. $\sigma(g) = \varphi^{-1}\circ g\circ \varphi$ for all $g\in G_K$, and is uniquely determined by this property.
\end{step}

\begin{proof}
Let $\tau:G_K\to G_{K'},\ g\mapsto \varphi^{-1}\circ g\circ \varphi$. Clearly, $\tau$ is a group isomorphism and we have $\tau(G_L)=G_{L'}=\sigma(G_L)$ for every finite subextension $L/K$ of $\overline{K}/K$. By applying Lemma \ref{3.2} on $\tau$, we get bijections $\tau: \operatorname{Spv}_\text{d}^{(1)}(L)\to \operatorname{Spv}_\text{d}^{(1)}(L')$ for any intermediate field $L$ of $\overline{K}/K$.

We have $L_{\tau(v)} = (L_v)' = L_{\sigma(v)}$ for all $v\in\operatorname{Spv}_\text{d}^{(1)}(L)$, i.e. $\sigma$ and $\tau$ induce the same maps $\operatorname{Spv}_\text{d}^{(1)}(L)\to \operatorname{Spv}_\text{d}^{(1)}(L')$. By limit process, $\sigma$ and $\tau$ induce the same map $\operatorname{Spv}_\text{d}^{(1)}(\overline{K})\to \operatorname{Spv}_\text{d}^{(1)}(\overline{K}')$.

Let $g\in G_K$ and $\overline{v}\in\operatorname{Spv}_\text{d}^{(1)}(\overline{K})$. By Remark \ref{3.3} we have:
\[ \sigma(g)\sigma(\overline{v}) = \sigma(g\overline{v}) = \tau(g\overline{v}) = \tau(g)\tau(\overline{v}) = \tau(g) \sigma(\overline{v}) \]
Therefore $\sigma(g)^{-1}\tau(g)$ is contained in $G_{\overline{v}}$ for all $\overline{v}\in\operatorname{Spv}_\text{d}^{(1)}(\overline{K})$. By the Theorem of F.K. Schmidt we have $G_{\overline{v}_1}\cap G_{\overline{v}_2} = 1$ for $\overline{v}_1\neq\overline{v}_2$. Therefore, $\sigma(g) = \tau(g) = \varphi^{-1}g\varphi$ for all $g\in G_K$.

For the uniqueness of $\varphi$ let $\psi: \overline{K}'\to \overline{K}$ be another isomorphism with $\sigma(g) = \psi^{-1} g \psi$. Setting $h = \psi\varphi^{-1}\in G_K$ we observe
\[ h^{-1}gh = \varphi\sigma(g)\varphi^{-1} = \sigma^{-1}\sigma(g) = g \]
for all $g\in G_K$. For $\overline{v}\in\operatorname{Spv}_\text{d}^{(1)}(\overline{K})$ we have therefore $G_{\overline{v}} = h G_{\overline{v}} h^{-1} = G_{h\overline{v}}$, thus $h\in G_{\overline{v}}$ for all $\overline{v}$. Again, by F.K. Schmidt, we have $h=1$ and thus $\varphi = \psi$.
\end{proof}
